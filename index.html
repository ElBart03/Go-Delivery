<!DOCTYPE html>
<html lang="es">
<head>
<!-- Inserted by miarroba -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7294310421616689" crossorigin="anonymous"></script>
<script type='text/javascript' src='https://ads.vidoomy.com/miarroba_23335.js' async></script>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-T2VG59');</script>
<!-- Inserted by miarroba -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Go! Scanner Pro v3.5 Pro</title>
    
    <!-- PWA / App Instalable -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Librer√≠as -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* PALETA MASCULINA Y ELEGANTE (Slate, Navy, Bronze) */
            --primary: #0f172a; /* Slate 900 (Casi negro/azul) */
            --primary-dark: #020617; /* Slate 950 */
            --accent: #b45309; /* Bronce/Amber oscuro */
            --bg: #f1f5f9; /* Slate 100 (Gris claro elegante) */
            --surface: #ffffff;
            --text-main: #1e293b; /* Slate 800 */
            --text-sec: #64748b; /* Slate 500 */
            --danger: #991b1b; /* Rojo oscuro sobrio */
            --success: #15803d; /* Verde bosque */
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER & DASHBOARD --- */
        .top-bar {
            padding: 15px 20px;
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 10;
            border-bottom: 1px solid #e2e8f0;
        }
        .app-title { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 5px; letter-spacing: -0.5px; }
        .app-title span { color: var(--accent); }
        .date-display { font-size: 11px; font-weight: 700; color: var(--text-sec); background: #e2e8f0; color: var(--primary); padding: 4px 10px; border-radius: 6px; letter-spacing: 0.5px; }

        .dashboard {
            padding: 15px 20px;
            background: var(--surface);
            margin-bottom: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .stat-box { text-align: center; flex: 1; }
        .stat-value { font-size: 24px; font-weight: 900; color: var(--primary); line-height: 1.2; letter-spacing: -1px; }
        .stat-label { font-size: 10px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .divider { width: 1px; height: 30px; background: #e2e8f0; margin: 0 10px; }

        /* --- LISTA PRINCIPAL --- */
        .main-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px 140px 20px; 
            scroll-behavior: smooth;
        }
        
        .empty-state {
            text-align: center;
            margin-top: 50px;
            color: var(--text-sec);
            opacity: 0.7;
        }

        .card-item {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.2s, opacity 0.3s;
            border: 1px solid #f1f5f9;
            position: relative;
            overflow: hidden;
        }
        .card-item.entering { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card-info { display: flex; flex-direction: column; gap: 4px; }
        .code-text { font-size: 16px; font-family: monospace; font-weight: 700; color: var(--text-main); letter-spacing: 0.5px; }
        .meta-text { font-size: 12px; color: var(--text-sec); display: flex; align-items: center; gap: 6px; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.pedido { background: #f1f5f9; color: var(--primary); border: 1px solid #e2e8f0; }
        .badge.caso { background: #fff7ed; color: var(--accent); border: 1px solid #ffedd5; }
        .badge.manual { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }

        .btn-delete {
            background: #fef2f2; color: var(--danger); border: none;
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 16px; transition: 0.2s;
        }
        .btn-delete:active { transform: scale(0.9); background: #fee2e2; }

        .duplicate-alert {
            background: #fef2f2; border: 1px solid #fecaca;
            color: var(--danger); margin-bottom: 15px; border-radius: var(--radius);
            padding: 12px; font-size: 13px; font-weight: 600;
            display: flex; justify-content: space-between; align-items: center;
            animation: popIn 0.3s; cursor: pointer;
        }
        .card-item.repetido { border: 1px solid var(--danger); background: #fff5f5; }

        /* --- ESTILOS ACORDEON DETALLES --- */
        .detail-accordion {
            cursor: pointer; transition: background 0.2s; margin-bottom: 0; z-index: 2;
        }
        .detail-accordion:active { background-color: #f9fafb; }
        
        .sub-list-container {
            display: none; background: #f8fafc; margin: 0 0 15px 0;
            border-radius: 0 0 16px 16px; padding: 5px 10px 10px 10px;
            border: 1px solid #e2e8f0; border-top: none;
            animation: expandList 0.3s ease-out;
        }
        @keyframes expandList { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }

        .sub-item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #e2e8f0; font-size: 13px; color: var(--text-main);
        }
        .sub-item-row:last-child { border-bottom: none; }
        
        .btn-copy-mini {
            background: #f1f5f9; color: var(--primary); border: 1px solid #e2e8f0;
            padding: 6px 12px; border-radius: 6px; font-size: 10px;
            font-weight: 700; cursor: pointer; margin-left: 10px;
        }
        .btn-copy-mini:active { background: var(--primary); color: white; }
        
        .price-tag-mini {
            background: #f0fdf4; color: var(--success); padding: 4px 8px;
            border-radius: 4px; font-size: 11px; font-weight: 700; border: 1px solid #dcfce7;
        }

        /* --- BARRA DE ACCIONES INFERIOR --- */
        .bottom-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); /* Fondo oscuro */
            padding: 12px 20px; border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 100; border: 1px solid rgba(255,255,255,0.1);
        }

        .dock-btn {
            background: transparent; border: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #94a3b8; font-size: 10px; font-weight: 600;
            width: 60px; height: 50px; cursor: pointer; gap: 4px;
            transition: color 0.2s;
        }
        .dock-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .dock-btn:active { color: white; transform: scale(0.95); }

        .scan-fab {
            width: 60px; height: 60px;
            background: var(--surface);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
            color: var(--primary); border: 2px solid var(--accent); cursor: pointer;
            font-size: 24px; margin-top: -35px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .scan-fab:active { transform: scale(0.9) translateY(2px); box-shadow: 0 0 5px rgba(255,255,255,0.2); }
        .scan-fab.loading { animation: pulse 1.5s infinite; filter: grayscale(0.5); }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(180, 83, 9, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(180, 83, 9, 0); } 100% { box-shadow: 0 0 0 0 rgba(180, 83, 9, 0); } }

        /* --- MODAL / BOTTOM SHEET --- */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .sheet-overlay.active { opacity: 1; pointer-events: auto; }

        .bottom-sheet {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 25px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            z-index: 201;
            transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh;
            overflow-y: auto;
        }
        .bottom-sheet.active { bottom: 0; }
        
        .sheet-handle { width: 40px; height: 4px; background: #e2e8f0; border-radius: 10px; margin: 0 auto 20px auto; }
        .input-group { margin-bottom: 15px; position: relative; }
        .styled-input {
            width: 100%; padding: 16px; border: 2px solid #e2e8f0;
            border-radius: 12px; font-size: 18px; text-align: center;
            font-weight: bold; outline: none; transition: border 0.3s;
            color: var(--text-main); background: #f8fafc; font-family: monospace;
        }
        .styled-input:focus { border-color: var(--primary); background: white; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; padding-bottom: 10px; }
        .btn-sheet {
            padding: 16px; border-radius: 12px; border: none;
            font-weight: 700; cursor: pointer; font-size: 14px; letter-spacing: 0.5px;
        }
        .btn-sheet.primary { background: var(--primary); color: white; }
        .btn-sheet.secondary { background: var(--accent); color: white; }

        /* --- DRAWER --- */
        .drawer {
            position: fixed; top: 0; left: -300px; width: 280px; height: 100%;
            background: var(--surface); z-index: 300;
            box-shadow: 5px 0 25px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            display: flex; flex-direction: column; padding: 20px;
        }
        .drawer.open { left: 0; }
        .history-list { flex: 1; overflow-y: auto; margin-top: 10px; }
        .history-item {
            padding: 12px; border-radius: 8px; margin-bottom: 8px;
            background: #f8fafc; display: flex; align-items: center;
            justify-content: space-between; font-size: 13px;
            border: 1px solid #e2e8f0; cursor: pointer;
        }
        .history-item.active { background: #f1f5f9; color: var(--primary); border-color: var(--primary); font-weight: bold; }
        .drawer-btn {
            background: var(--primary); color: white; width: 100%;
            padding: 14px; border-radius: 8px; border: none;
            font-weight: 600; margin-top: 10px; cursor: pointer;
        }

        /* --- NOTIFICACI√ìN --- */
        #autosave-pill {
            position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 8px 20px;
            border-radius: 30px; font-size: 12px; font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000;
            transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; gap: 8px;
        }
        #autosave-pill.show { top: 20px; }

        .progress-line { position: fixed; top: 0; left: 0; height: 4px; background: var(--accent); width: 0%; z-index: 500; transition: width 0.2s; }
        
        /* Modal Detalles Resumen */
        .modal-fullscreen {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.98); z-index: 400;
            flex-direction: column; padding: 30px 20px;
            overflow-y: auto;
        }
        .big-total { font-size: 48px; font-weight: 900; color: var(--success); text-align: center; margin: 20px 0; letter-spacing: -2px; }

    </style>
</head>
<body>

<!-- Inserted by miarroba -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T2VG59" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- Inserted by miarroba -->

<div id="progress-line" class="progress-line"></div>
<div id="autosave-pill"><span>üíæ</span> <span id="pill-label">Guardado</span></div>

<!-- DRAWER HISTORIAL -->
<div class="sheet-overlay" id="drawer-overlay" onclick="toggleDrawer()"></div>
<div class="drawer" id="main-drawer">
    <h2 style="margin:0; color:var(--primary);">Historial üìÖ</h2>
    <div style="font-size:12px; color:#999; margin-bottom:15px;">Gestiona tus d√≠as</div>
    
    <button class="drawer-btn" style="background:#475569; margin-top:0; margin-bottom:5px; padding:10px;" onclick="seleccionarTodo()">‚úÖ Marcar Todo</button>
    <button class="drawer-btn" style="background:var(--primary); margin-top:0; margin-bottom:15px; padding:10px;" onclick="verResumenSeleccionado()">üìä Ver Total Selecci√≥n</button>

    <div class="history-list" id="lista-historial"></div>
    <div style="margin-top:auto">
        <button class="drawer-btn" style="background:var(--success)" onclick="descargarTxtProfesional()">üìÑ Descargar TXT</button>
        <button class="drawer-btn" style="background:#fef2f2; color:var(--danger); border:1px solid #fecaca; margin-top:8px;" onclick="vaciarTodo()">üóëÔ∏è Borrar Todo</button>
        <p style="text-align:center; color:#ccc; font-size:10px; margin-top:10px;">ElBartO v3.5 Pro</p>
    </div>
</div>

<!-- HEADER -->
<div class="top-bar">
    <div class="app-title">Go! <span>üöÄ</span> <span style="font-size:12px; color:#999; margin-left:5px;">v3.5 Pro</span></div>
    <div class="date-display" id="viewing-date-top">HOY</div>
</div>

<!-- DASHBOARD STATS -->
<div class="dashboard">
    <div class="stat-box">
        <div class="stat-value" id="stat-pedidos">0</div>
        <div class="stat-label">Pedidos</div>
    </div>
    <div class="divider"></div>
    <div class="stat-box">
        <div class="stat-value" id="stat-casos" style="color:var(--accent)">0</div>
        <div class="stat-label">Casos</div>
    </div>
    <div class="divider"></div>
    <div class="stat-box">
        <div class="stat-value" id="stat-monto" style="color:var(--success)">S/0</div>
        <div class="stat-label">Total Est.</div>
    </div>
</div>

<!-- LISTA PRINCIPAL (SCROLL AREA) -->
<div class="main-scroll-area" id="main-list-area">
    <div id="duplicate-banner" class="duplicate-alert" style="display:none;" onclick="eliminarRepetidos()">
        <span>‚ö†Ô∏è Se encontraron duplicados</span>
        <span style="text-decoration:underline;">LIMPIAR</span>
    </div>
    <div id="lista-items">
        <!-- JS renderiza aqu√≠ -->
        <div class="empty-state">
            <div style="font-size:40px; margin-bottom:10px;">üì∑</div>
            Toca el bot√≥n central<br>para escanear gu√≠as
        </div>
    </div>
</div>

<!-- BOTTOM DOCK (MENU INFERIOR) -->
<div class="bottom-dock">
    <button class="dock-btn" onclick="toggleDrawer()">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"></path></svg>
        Historial
    </button>
    
    <div style="position:relative;">
        <label for="camera-input" class="scan-fab" id="scan-btn" onclick="playSound('click')">
            üì∑
        </label>
        <input type="file" id="camera-input" accept="image/*" multiple style="display:none;">
    </div>

    <button class="dock-btn" onclick="toggleManualSheet()">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
        Manual
    </button>
</div>

<!-- SHEET MANUAL -->
<div class="sheet-overlay" id="manual-overlay" onclick="toggleManualSheet()"></div>
<div class="bottom-sheet" id="manual-sheet">
    <div class="sheet-handle"></div>
    
    <!-- ACCIONES R√ÅPIDAS (MODIFICADO: SOLO ARCHIVO) -->
    <div style="margin-bottom:20px;">
        <button onclick="document.getElementById('manual-gallery').click()" style="width:100%; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; background: #f8fafc; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s;" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">
            <span style="font-size: 28px;">üìÅ</span>
            <span style="font-size: 13px; font-weight: 700; color: var(--primary);">Subir Archivo / Foto</span>
        </button>
    </div>

    <!-- SEPARADOR -->
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
        <div style="flex:1; height:1px; background:#e2e8f0;"></div>
        <span style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase;">O Ingresa Manualmente</span>
        <div style="flex:1; height:1px; background:#e2e8f0;"></div>
    </div>

    <!-- INPUTS MANUALES -->
    <div class="input-group">
        <input type="number" id="manualInput" class="styled-input" placeholder="Escribe el c√≥digo..." inputmode="numeric" oninput="if(this.value.length > 8) this.value = this.value.slice(0,8);">
    </div>
    
    <div class="input-group">
        <input type="number" id="precioManual" class="styled-input" placeholder="Precio S/. (Opcional)" style="font-size:14px; padding:12px; background:#fffbeb; border-color:#fde68a;">
    </div>
    
    <div class="btn-row">
        <button class="btn-sheet primary" onclick="agregarManual('PEDIDO')">+ PEDIDO</button>
        <button class="btn-sheet secondary" onclick="agregarManual('CASO')">+ CASO</button>
    </div>
</div>

<!-- MODAL REVIEW MANUAL (POPUP) -->
<div class="sheet-overlay" id="manual-review-overlay"></div>
<div class="bottom-sheet" id="manual-review-sheet" style="padding:0; border-radius:24px 24px 0 0; display:flex; flex-direction:column; max-height:85vh;">
    <div style="padding:15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--primary); font-size:16px;">Revisi√≥n Manual (<span id="review-count">0</span>)</h3>
        <button onclick="closeManualReview()" style="background:none; border:none; color:var(--text-sec); font-size:20px;">‚úï</button>
    </div>
    <div id="manual-review-list" style="flex:1; overflow-y:auto; padding:15px; background:#f8fafc;"></div>
    <div style="padding:15px; border-top:1px solid #e2e8f0;">
        <button onclick="confirmManualImport()" class="btn-sheet primary" style="width:100%;">IMPORTAR A LA LISTA</button>
    </div>
</div>

<!-- Inputs Ocultos -->
<input type="file" id="manual-cam" accept="image/*" capture="environment" style="display:none">
<input type="file" id="manual-gallery" accept="image/*" style="display:none">
<!-- Nuevo input para Excel -->
<input type="file" id="excel-input" accept=".xlsx, .xls" style="display:none;">

<!-- MODAL DETALLES FULLSCREEN -->
<div class="modal-fullscreen" id="modal-detalles">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; color:var(--primary);">Resumen</h2>
        <button onclick="document.getElementById('modal-detalles').style.display='none'" style="font-size:24px; border:none; background:none; color:var(--text-sec);">‚úï</button>
    </div>
    <div id="total-pago-full" class="big-total">S/. 0.00</div>
    <div style="text-align:center; color:#666; margin-bottom:20px;">
        Precio Base: <b id="lbl-precio-base">S/. 5.00</b> <button onclick="cambiarPrecio()" style="margin-left:5px; border-radius:50%; border:1px solid #ccc;">‚öôÔ∏è</button>
    </div>
    <div id="detalle-breakdown" style="flex:1;">
        <!-- Se llena con JS -->
    </div>
    <button class="btn-sheet primary" style="margin-top:20px;" onclick="document.getElementById('modal-detalles').style.display='none'">CERRAR</button>
</div>

<script>
    // --- LOGICA DE AUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        if (type === 'success') {
            osc.frequency.setValueAtTime(880, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'error') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        } else if (type === 'click') {
            osc.frequency.setValueAtTime(400, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
            osc.start(); osc.stop(now + 0.05);
            if (navigator.vibrate) navigator.vibrate(15);
        } else if (type === 'delete') {
            osc.frequency.setValueAtTime(200, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        }
    }

    // --- VARIABLES Y ESTADO ---
    let dbRutas = JSON.parse(localStorage.getItem('rutasGoV3')) || {};
    let precioPorPedido = parseFloat(localStorage.getItem('precioGo')) || 5.00;
    
    // CORRECCI√ìN HORA LOCAL
    const getLocalISO = () => {
        const d = new Date();
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - offset).toISOString().split('T')[0];
    };
    let fechaSeleccionada = getLocalISO();
    let modoSeleccionActivo = false; 
    let manualCandidates = []; // Array temporal para revisi√≥n manual
    let datosComparacion = []; // Array para auditor√≠a vs Excel

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', () => { 
        renderizarTodo(); 
        document.getElementById('lbl-precio-base').innerText = `S/. ${precioPorPedido.toFixed(2)}`;
    });

    // --- FUNCIONES UI ---
    function formatearFecha(fechaISO) {
        if(!fechaISO) return "";
        const dias = ["DOM", "LUN", "MAR", "MIE", "JUE", "VIE", "SAB"];
        const [a, m, d] = fechaISO.split('-');
        const fechaObj = new Date(a, m - 1, d);
        return `${dias[fechaObj.getDay()]} ${d}/${m}`;
    }

    function toggleDrawer() {
        const d = document.getElementById('main-drawer');
        const o = document.getElementById('drawer-overlay');
        const isOpen = d.classList.contains('open');
        
        if (!isOpen) {
            d.classList.add('open'); o.classList.add('active');
            renderHistorial();
        } else {
            d.classList.remove('open'); o.classList.remove('active');
        }
        playSound('click');
    }

    function toggleManualSheet() {
        const s = document.getElementById('manual-sheet');
        const o = document.getElementById('manual-overlay');
        const isActive = s.classList.contains('active');
        
        if (!isActive) {
            s.classList.add('active'); o.classList.add('active');
            // No auto-focus si hay botones grandes
        } else {
            s.classList.remove('active'); o.classList.remove('active');
            document.getElementById('manualInput').blur();
        }
        playSound('click');
    }

    function mostrarFeedback(msg) {
        const pill = document.getElementById('autosave-pill');
        document.getElementById('pill-label').innerText = msg;
        pill.classList.add('show');
        setTimeout(() => pill.classList.remove('show'), 2000);
    }

    // --- FUNCIONES AUXILIARES DETALLES ---
    function toggleSubDetails(id) {
        const el = document.getElementById(id);
        const isHidden = el.style.display === 'none' || el.style.display === '';
        document.querySelectorAll('.sub-list-container').forEach(d => d.style.display = 'none'); 
        if (isHidden) {
            el.style.display = 'block';
            playSound('click');
        }
    }

    function copiarCodigo(codigo) {
        navigator.clipboard.writeText(codigo).then(() => {
            mostrarFeedback("Copiado: " + codigo);
            playSound('success');
        }).catch(err => {
            console.error('Error al copiar', err);
        });
    }

    function copiarBloque(codigosStr) {
        if(!codigosStr) return;
        const texto = codigosStr.split('|').join('\n');
        const cantidad = codigosStr.split('|').length;

        // Intento con API Moderna
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(texto).then(() => {
                mostrarFeedback(`‚úÖ ¬°${cantidad} C√ìDIGOS COPIADOS!`);
                playSound('success');
            }).catch(err => {
                copyFallback(texto, cantidad);
            });
        } else {
            // Fallback directo
            copyFallback(texto, cantidad);
        }
    }

    function copyFallback(texto, cantidad) {
        const textArea = document.createElement("textarea");
        textArea.value = texto;
        
        // Evitar scroll al fondo
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        textArea.style.top = "0";
        document.body.appendChild(textArea);
        
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if(successful) {
                mostrarFeedback(`‚úÖ ¬°${cantidad} C√ìDIGOS COPIADOS!`);
                playSound('success');
            } else {
                alert("No se pudo copiar autom√°ticamente. Intenta manualmente.");
            }
        } catch (err) {
            console.error('Fallback error', err);
        }
        
        document.body.removeChild(textArea);
    }

    function seleccionarTodo() {
        playSound('click');
        const checks = document.querySelectorAll('.day-checkbox');
        const algunDesmarcado = Array.from(checks).some(c => !c.checked);
        checks.forEach(c => c.checked = algunDesmarcado);
    }

    function verResumenSeleccionado() {
        playSound('click');
        const checks = document.querySelectorAll('.day-checkbox:checked');
        if (checks.length === 0) return alert("‚ö†Ô∏è Selecciona d√≠as en la lista primero.");
        
        modoSeleccionActivo = true;
        
        let itemsPedidosScan = [], itemsPedidosMan = [];
        let itemsCasosScan = [], itemsCasosMan = [];
        let mTotal = 0;

        checks.forEach(c => {
            const f = c.value;
            if(dbRutas[f]) {
                dbRutas[f].forEach(r => {
                    if(!r.esRepetido) {
                        let precio = r.precioEspecial ? parseFloat(r.precioEspecial) : precioPorPedido;
                        mTotal += precio;
                        let itemObj = { codigo: r.numero, precio: precio.toFixed(2), esManual: r.esManual, tipo: r.tipo, fecha: formatearFecha(f) };
                        
                        // CLASIFICACION DETALLADA
                        if(r.tipo === 'PEDIDO') {
                            if(r.esManual) itemsPedidosMan.push(itemObj);
                            else itemsPedidosScan.push(itemObj);
                        } else {
                            if(r.esManual) itemsCasosMan.push(itemObj);
                            else itemsCasosScan.push(itemObj);
                        }
                    }
                });
            }
        });

        mostrarModalGenerico(itemsPedidosScan, itemsPedidosMan, itemsCasosScan, itemsCasosMan, mTotal);
    }

    // --- LOGICA DE NEGOCIO ---
    function guardarRuta(numero, tipo, fechaUsar, precioEsp = null, esManual = false) {
        if (!dbRutas[fechaUsar]) dbRutas[fechaUsar] = [];
        let esDuplicado = false;
        
        for (let f in dbRutas) { 
            if (dbRutas[f].some(r => r.numero === numero && !r.esRepetido)) { 
                esDuplicado = true; break; 
            }
        }
        if (esManual && dbRutas[fechaUsar].some(r => r.numero === numero)) esDuplicado = true;

        if(esDuplicado) playSound('error'); 
        else if(esManual) playSound('success');

        dbRutas[fechaUsar].push({ 
            id: Date.now() + Math.random(), 
            numero, tipo, 
            esRepetido: esDuplicado, 
            precioEspecial: precioEsp, esManual: esManual 
        });
        
        actualizarStorage(true);
    }

    function actualizarStorage(shouldScroll = false) {
        localStorage.setItem('rutasGoV3', JSON.stringify(dbRutas));
        mostrarFeedback("Guardado");
        renderizarTodo(shouldScroll);
    }

    function renderizarTodo(shouldScroll = false) {
        const contenedor = document.getElementById('lista-items');
        const rutas = dbRutas[fechaSeleccionada] || [];
        
        const dateEl = document.getElementById('viewing-date-top');
        if (rutas.length === 0) {
            dateEl.innerText = "";
            dateEl.style.display = 'none';
        } else {
            dateEl.innerText = formatearFecha(fechaSeleccionada);
            dateEl.style.display = 'block';
        }
        
        let p = 0, c = 0, mTotal = 0, hayRepetidos = false;
        rutas.forEach(r => {
            if(!r.esRepetido) {
                let precio = r.precioEspecial ? parseFloat(r.precioEspecial) : precioPorPedido;
                if(r.tipo === 'CASO') c++; else p++;
                mTotal += precio;
            } else {
                hayRepetidos = true;
            }
        });

        document.getElementById('stat-pedidos').innerText = p;
        document.getElementById('stat-casos').innerText = c;
        document.getElementById('stat-monto').innerText = `S/.${Math.round(mTotal)}`;
        document.getElementById('duplicate-banner').style.display = hayRepetidos ? 'flex' : 'none';

        if (rutas.length === 0) {
            contenedor.innerHTML = `<div class="empty-state"><div style="font-size:40px; margin-bottom:10px;">üì∑</div>Sin registros hoy</div>`;
            return;
        }

        contenedor.innerHTML = "";
        
        rutas.forEach((r, idx) => {
            const div = document.createElement('div');
            div.className = `card-item entering ${r.esRepetido ? 'repetido' : ''}`;
            
            let tipoBadge = r.tipo === 'CASO' ? 'caso' : 'pedido';
            let precioTag = r.precioEspecial ? `<span style="color:#059669; font-weight:bold; font-size:11px; margin-left:5px;">S/.${r.precioEspecial}</span>` : '';
            let manualTag = r.esManual ? `<span class="badge manual" style="margin-left:5px;">‚úèÔ∏è</span>` : '';

            div.innerHTML = `
                <div class="card-info">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="color:#999; font-size:12px; font-weight:bold;">#${idx+1}</span>
                        <div class="code-text">${r.numero}</div>
                    </div>
                    <div class="meta-text" style="padding-left:25px;">
                        <span class="badge ${tipoBadge}">${r.tipo}</span>
                        ${manualTag}
                        ${precioTag}
                    </div>
                </div>
                <button class="btn-delete" onclick="eliminarRuta(${r.id})">‚úï</button>
            `;
            contenedor.appendChild(div);
        });

        if (shouldScroll) {
             document.getElementById('main-list-area').scrollTop = 0;
        }
    }

    function renderHistorial() {
        const lista = document.getElementById('lista-historial');
        lista.innerHTML = "";
        Object.keys(dbRutas).sort().reverse().forEach(f => {
            const item = document.createElement('div');
            item.className = `history-item ${f === fechaSeleccionada ? 'active' : ''}`;
            const count = dbRutas[f].length;
            item.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; flex:1" onclick="seleccionarDia('${f}')">
                    <input type="checkbox" class="day-checkbox" value="${f}" ${f === fechaSeleccionada ? 'checked' : ''} onclick="event.stopPropagation()">
                    <div>
                        <div style="font-weight:700;">${formatearFecha(f)}</div>
                        <div style="color:#999; font-size:11px;">${count} registros</div>
                    </div>
                </div>
                <button onclick="borrarDia(event, '${f}')" style="background:none; border:none; color:#ef4444; font-weight:bold; padding:10px;">‚úï</button>
            `;
            lista.appendChild(item);
        });
    }

    function seleccionarDia(f) {
        fechaSeleccionada = f;
        renderizarTodo();
        toggleDrawer();
    }

    function borrarDia(e, f) {
        e.stopPropagation();
        if(confirm("¬øEliminar este d√≠a?")) {
            delete dbRutas[f];
            if(f === fechaSeleccionada) fechaSeleccionada = getLocalISO();
            actualizarStorage();
            renderHistorial();
        }
    }

    function vaciarTodo() {
        if(confirm("‚ö† ¬øEST√ÅS SEGURO? Se borrar√° todo el historial.")) {
            dbRutas = {};
            localStorage.removeItem('rutasGoV3');
            fechaSeleccionada = getLocalISO();
            renderizarTodo(); renderHistorial(); toggleDrawer();
        }
    }

    function eliminarRuta(id) {
        playSound('delete');
        dbRutas[fechaSeleccionada] = dbRutas[fechaSeleccionada].filter(r => r.id !== id);
        actualizarStorage();
    }

    function eliminarRepetidos() {
        playSound('delete');
        dbRutas[fechaSeleccionada] = dbRutas[fechaSeleccionada].filter(r => !r.esRepetido);
        actualizarStorage();
    }

    function agregarManual(tipo) {
        const input = document.getElementById('manualInput');
        const precio = document.getElementById('precioManual');
        const val = input.value.trim();
        
        if (val.length > 0) {
            guardarRuta(val, tipo, fechaSeleccionada, precio.value.trim() || null, true);
            input.value = ""; precio.value = "";
            toggleManualSheet();
        } else {
            input.focus();
        }
    }

    function cambiarPrecio() {
        let n = prompt("Precio base por registro (S/.):", precioPorPedido);
        if (n && !isNaN(n)) {
            precioPorPedido = parseFloat(n);
            localStorage.setItem('precioGo', precioPorPedido);
            document.getElementById('lbl-precio-base').innerText = `S/. ${precioPorPedido.toFixed(2)}`;
            renderizarTodo();
            // CORRECCI√ìN PRECIO INSTANT√ÅNEO
            if(document.getElementById('modal-detalles').style.display === 'flex') {
                if(modoSeleccionActivo) {
                    verResumenSeleccionado();
                } else {
                    mostrarDetalles();
                }
            }
        }
    }

    function mostrarDetalles() {
        modoSeleccionActivo = false; 
        
        const rutas = dbRutas[fechaSeleccionada] || [];
        let itemsPedidosScan = [], itemsPedidosMan = [];
        let itemsCasosScan = [], itemsCasosMan = [];
        let mTotal = 0;

        rutas.forEach(r => {
            if(!r.esRepetido) {
                let precio = r.precioEspecial ? parseFloat(r.precioEspecial) : precioPorPedido;
                mTotal += precio;
                let itemObj = { codigo: r.numero, precio: precio.toFixed(2), esManual: r.esManual, tipo: r.tipo };
                
                // SEPARACION COMPLETA EN 4 GRUPOS
                if(r.tipo === 'PEDIDO') {
                    if(r.esManual) itemsPedidosMan.push(itemObj);
                    else itemsPedidosScan.push(itemObj);
                } else {
                    if(r.esManual) itemsCasosMan.push(itemObj);
                    else itemsCasosScan.push(itemObj);
                }
            }
        });
        
        mostrarModalGenerico(itemsPedidosScan, itemsPedidosMan, itemsCasosScan, itemsCasosMan, mTotal);
    }

    function mostrarModalGenerico(pScan, pMan, cScan, cMan, mTotal) {
        // --- GUARDAR DATOS PARA LA COMPARACION EXCEL ---
        datosComparacion = [...pScan, ...pMan, ...cScan, ...cMan];
        // -----------------------------------------------

        document.getElementById('total-pago-full').innerText = `S/. ${mTotal.toFixed(2)}`;

        const generarListaHTML = (items) => {
            if (items.length === 0) return '<div style="padding:10px; text-align:center; color:#999; font-size:12px;">Sin registros</div>';
            
            // BOTON DE COPIA MASIVA AL INICIO DE LA LISTA
            const todosCodigos = items.map(i => i.codigo).join('|');
            const btnMasivo = `<div style="padding:0 10px 5px 10px;"><button class="btn-copy-mini" style="width:100%; margin:0; padding:8px; background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd;" onclick="event.stopPropagation(); copiarBloque('${todosCodigos}')">üìë COPIAR TODO (VERTICAL)</button></div>`;

            const listado = items.map(i => `
                <div class="sub-item-row">
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:700; letter-spacing:0.5px;">${i.codigo}</span>
                        ${i.fecha ? `<span style="font-size:10px; color:#999;">${i.fecha}</span>` : ''}
                    </div>
                    <div style="display:flex; align-items:center;">
                        ${i.esManual ? '<span style="font-size:10px; margin-right:5px;">‚úèÔ∏è</span>' : ''}
                        <span class="price-tag-mini">S/.${i.precio}</span>
                        <button class="btn-copy-mini" onclick="event.stopPropagation(); copiarCodigo('${i.codigo}')">COPIAR</button>
                    </div>
                </div>
            `).join('');
            
            return btnMasivo + listado;
        };

        const container = document.getElementById('detalle-breakdown');
        
        // Calculos subtotales
        const totalPScan = pScan.reduce((a,b)=>a+parseFloat(b.precio),0);
        const totalPMan = pMan.reduce((a,b)=>a+parseFloat(b.precio),0);
        const totalCScan = cScan.reduce((a,b)=>a+parseFloat(b.precio),0);
        const totalCMan = cMan.reduce((a,b)=>a+parseFloat(b.precio),0);

        const cardResumen = `
            <div class="card-item" style="display:block; background:#f9fafb; border:1px solid #e5e7eb;">
                <h3 style="margin:0 0 10px 0; font-size:14px; text-transform:uppercase; color:#666;">Tablero Resumen Detallado</h3>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span>üì¶ Pedidos (Scan) (${pScan.length})</span>
                    <b>S/. ${totalPScan.toFixed(2)}</b>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#64748b;">
                    <span>‚úèÔ∏è Pedidos (Manual) (${pMan.length})</span>
                    <b>S/. ${totalPMan.toFixed(2)}</b>
                </div>

                <div style="border-top:1px solid #e2e8f0; margin:5px 0;"></div>

                <div style="display:flex; justify-content:space-between; margin-bottom:4px; color:#d97706;">
                    <span>üìÇ Casos (Scan) (${cScan.length})</span>
                    <b>S/. ${totalCScan.toFixed(2)}</b>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#b45309;">
                    <span>‚úèÔ∏è Casos (Manual) (${cMan.length})</span>
                    <b>S/. ${totalCMan.toFixed(2)}</b>
                </div>

                <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:8px; display:flex; justify-content:space-between; font-weight:900;">
                    <span>TOTAL ITEMS</span>
                    <span>${pScan.length + pMan.length + cScan.length + cMan.length}</span>
                </div>
            </div>
        `;

        const toolsBlock = `
            <div style="margin-top:15px; border-top:1px dashed #e2e8f0; padding-top:15px; margin-bottom:15px;">
                <h3 style="margin:0 0 10px 0; font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase;">Herramientas & Auditor√≠a</h3>
                
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:12px;">
                    <!-- Excel Button -->
                    <input type="file" id="excel-audit-input" accept=".xlsx, .xls" style="display:none" onchange="procesarComparacionExcel(this)">
                    <button onclick="document.getElementById('excel-audit-input').click()" style="width:100%; padding:14px; border-radius:10px; background:#10b981; color:white; border:none; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 2px 4px rgba(16, 185, 129, 0.2); transition:transform 0.1s;">
                        <span style="font-size:16px;">üìó</span> CARGAR PLANILLA EXCEL
                    </button>
                    
                    <!-- Audit Results Area -->
                    <div id="audit-results" style="margin-top:10px;"></div>

                    <!-- Divider -->
                    <div style="height:1px; background:#cbd5e1; margin:15px 0;"></div>

                    <!-- Google Forms Button -->
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdoqmno0DO0h9hvw4fp7hKTEK5PG7gez_y-uunra2PKkrTxBw/viewform" target="_blank" style="text-decoration:none;">
                        <button style="width:100%; padding:14px; border-radius:10px; background:#6366f1; color:white; border:none; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 2px 4px rgba(99, 102, 241, 0.2); transition:transform 0.1s;" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">
                            <span style="font-size:16px;">üìù</span> REGISTRAR MANUALES (FORMS)
                        </button>
                    </a>
                </div>
            </div>
        `;

        const listsBlock = `
            <div style="display:flex; flex-direction:column; gap:10px;">
                <div style="font-size:11px; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">‚¨áÔ∏è Detalle de Listas ‚¨áÔ∏è</div>
                
                <div class="card-item detail-accordion" onclick="toggleSubDetails('lista-p-scan')">
                    <b>üì¶ Pedidos Escaneados</b> <span>‚ñº</span>
                </div>
                <div id="lista-p-scan" class="sub-list-container">${generarListaHTML(pScan)}</div>

                <div class="card-item detail-accordion" style="background:#f8fafc;" onclick="toggleSubDetails('lista-p-man')">
                    <b style="color:#64748b;">‚úèÔ∏è Pedidos Manuales</b> <span>‚ñº</span>
                </div>
                <div id="lista-p-man" class="sub-list-container">${generarListaHTML(pMan)}</div>

                <div class="card-item detail-accordion" onclick="toggleSubDetails('lista-c-scan')">
                    <b style="color:var(--accent)">üìÇ Casos Escaneados</b> <span>‚ñº</span>
                </div>
                <div id="lista-c-scan" class="sub-list-container">${generarListaHTML(cScan)}</div>

                <div class="card-item detail-accordion" style="background:#fff7ed;" onclick="toggleSubDetails('lista-c-man')">
                    <b style="color:#b45309;">‚úèÔ∏è Casos Manuales</b> <span>‚ñº</span>
                </div>
                <div id="lista-c-man" class="sub-list-container">${generarListaHTML(cMan)}</div>
            </div>
        `;

        container.innerHTML = cardResumen + toolsBlock + listsBlock;
        document.getElementById('modal-detalles').style.display = 'flex';
    }

    document.getElementById('camera-input').onchange = async function() {
        const files = Array.from(this.files);
        if (files.length === 0) return;

        const scanBtn = document.getElementById('scan-btn');
        const pLine = document.getElementById('progress-line');
        
        scanBtn.classList.add('loading');
        scanBtn.innerText = "‚è≥";
        playSound('click');

        for (let i = 0; i < files.length; i++) {
            pLine.style.width = `${((i+1)/files.length)*100}%`;
            try {
                const { data: { text } } = await Tesseract.recognize(files[i], 'spa+eng');
                let fechaHoja = fechaSeleccionada;
                let fechaEncontrada = false;

                const regexFecha = /(\d{1,2})[\/\- ](\d{1,2})[\/\- ](\d{2,4})/.exec(text);
                if(regexFecha) {
                    let d = regexFecha[1].padStart(2, '0'), m = regexFecha[2].padStart(2, '0'), a = regexFecha[3];
                    if(a.length === 2) a = "20" + a;
                    fechaHoja = `${a}-${m}-${d}`;
                    fechaSeleccionada = fechaHoja;
                    fechaEncontrada = true;
                }
                
                text.split('\n').forEach(linea => {
                    const regexNum = /(?:0)?(1\d{7,10})/.exec(linea);
                    if (regexNum) {
                        const esCaso = linea.toUpperCase().includes("CASO") || linea.toUpperCase().includes("OP") || linea.startsWith('0');
                        guardarRuta(regexNum[1], esCaso ? 'CASO' : 'PEDIDO', fechaHoja, null, false);
                    }
                });
                
                if(fechaEncontrada) renderHistorial();

            } catch (err) { console.error(err); playSound('error'); }
        }

        scanBtn.classList.remove('loading');
        scanBtn.innerText = "üì∑";
        pLine.style.width = "0%";
        playSound('success');
        this.value = "";
    };

    // --- NUEVA L√ìGICA OCR MANUAL CON POPUP ---
    async function processManualImage(inputElement) {
        const files = Array.from(inputElement.files);
        if (files.length === 0) return;

        mostrarFeedback("Analizando...");
        playSound('click');
        manualCandidates = []; // Resetear

        try {
            for (let i = 0; i < files.length; i++) {
                const { data: { text } } = await Tesseract.recognize(files[i], 'spa+eng');
                
                // Buscar TODOS los c√≥digos de 8 d√≠gitos que empiecen con 1
                const regex = /\b1\d{7}\b/g;
                let match;
                while ((match = regex.exec(text)) !== null) {
                    // Detectar si es caso o pedido por contexto
                    // Miramos un poco alrededor del match
                    const startIndex = Math.max(0, match.index - 20);
                    const context = text.substring(startIndex, match.index + 20).toUpperCase();
                    const isCaso = context.includes('CASO') || context.includes('OP');
                    
                    manualCandidates.push({
                        id: Math.random().toString(36),
                        code: match[0],
                        type: isCaso ? 'CASO' : 'PEDIDO'
                    });
                }
            }

            if (manualCandidates.length > 0) {
                renderManualModal();
                openManualReview();
                playSound('success');
            } else {
                playSound('error');
                alert("No se detectaron c√≥digos 1xxxxxxx v√°lidos.");
            }
        } catch (err) {
            console.error(err);
            playSound('error');
            alert("Error al procesar la imagen.");
        }
        
        inputElement.value = "";
    }

    function openManualReview() {
        document.getElementById('manual-review-overlay').classList.add('active');
        document.getElementById('manual-review-sheet').classList.add('active');
        // Cerrar el sheet manual anterior para evitar superposicion visual fea
        document.getElementById('manual-sheet').classList.remove('active');
    }

    function closeManualReview() {
        document.getElementById('manual-review-overlay').classList.remove('active');
        document.getElementById('manual-review-sheet').classList.remove('active');
        // Restaurar overlay si es necesario o dejarlo limpio
        document.getElementById('manual-overlay').classList.remove('active');
    }

    function renderManualModal() {
        const container = document.getElementById('manual-review-list');
        document.getElementById('review-count').innerText = manualCandidates.length;
        container.innerHTML = "";

        manualCandidates.forEach((item, index) => {
            const div = document.createElement('div');
            // Flex container, Input takes remaining space
            div.style.cssText = "background:white; padding:12px; margin-bottom:10px; border-radius:12px; border:1px solid #e2e8f0; display:flex; align-items:center; gap:10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);";

            // 1. Input Code
            const inputCode = document.createElement('input');
            inputCode.type = "text";
            inputCode.value = item.code;
            inputCode.style.cssText = "flex:1; border:none; background:transparent; font-family:monospace; font-size:18px; font-weight:bold; color:#1e293b; outline:none; min-width: 0;";
            inputCode.onchange = (e) => { item.code = e.target.value; };

            // 2. Slider Toggle (The requested feature)
            const toggleContainer = document.createElement('div');
            const isCaso = item.type === 'CASO';
            
            // Style for the track
            toggleContainer.style.cssText = `
                width: 80px; height: 34px; 
                background: ${isCaso ? '#fff7ed' : '#f1f5f9'}; 
                border: 1px solid ${isCaso ? '#ffedd5' : '#cbd5e1'};
                border-radius: 20px; 
                position: relative; 
                cursor: pointer; 
                transition: all 0.2s ease;
                display: flex; align-items: center; justify-content: space-between;
                padding: 2px;
                flex-shrink: 0;
            `;

            // The sliding knob
            const knob = document.createElement('div');
            knob.style.cssText = `
                width: 26px; height: 26px; 
                background: ${isCaso ? '#b45309' : '#0f172a'}; 
                border-radius: 50%; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
                transform: translateX(${isCaso ? '46px' : '0px'});
                z-index: 2;
            `;

            // Label text
            const labelText = document.createElement('span');
            labelText.innerText = isCaso ? "CASO" : "PED";
            labelText.style.cssText = `
                position: absolute; 
                width: 100%; text-align: ${isCaso ? 'left' : 'right'}; 
                padding: 0 10px;
                font-size: 10px; font-weight: 800; 
                color: ${isCaso ? '#b45309' : '#64748b'};
                pointer-events: none;
            `;

            toggleContainer.appendChild(labelText);
            toggleContainer.appendChild(knob);

            toggleContainer.onclick = () => {
                item.type = item.type === 'PEDIDO' ? 'CASO' : 'PEDIDO';
                renderManualModal(); // Re-render to update UI
            };

            // 3. Delete Button
            const btnDel = document.createElement('button');
            btnDel.innerHTML = "‚úï";
            btnDel.style.cssText = "background:transparent; color:#ef4444; border:none; width:30px; height:30px; font-size:18px; font-weight:bold; cursor:pointer; flex-shrink:0;";
            btnDel.onclick = () => {
                manualCandidates.splice(index, 1);
                renderManualModal();
            };

            // Order: Input -> Toggle -> Delete
            div.appendChild(inputCode);
            div.appendChild(toggleContainer);
            div.appendChild(btnDel);
            container.appendChild(div);
        });
    }

    function confirmManualImport() {
        if(manualCandidates.length === 0) return closeManualReview();
        
        manualCandidates.forEach(item => {
            guardarRuta(item.code, item.type, fechaSeleccionada, null, true); // true = esManual
        });
        
        playSound('success');
        closeManualReview();
        mostrarFeedback(`Importados ${manualCandidates.length} manuales`);
    }

    document.getElementById('manual-cam').onchange = function() { processManualImage(this); };
    document.getElementById('manual-gallery').onchange = function() { processManualImage(this); };

    function descargarTxtProfesional() {
        const checks = document.querySelectorAll('.day-checkbox:checked');
        let fechasExportar = [];
        
        if(checks.length > 0) {
            checks.forEach(c => fechasExportar.push(c.value));
        } else {
            if(dbRutas[fechaSeleccionada] && dbRutas[fechaSeleccionada].length > 0) {
                fechasExportar.push(fechaSeleccionada);
            }
        }
        
        if (fechasExportar.length === 0) {
            return alert("‚ö†Ô∏è No hay datos para descargar en la selecci√≥n o d√≠a actual.");
        }

        fechasExportar.sort();

        let contenido = "========================================\n";
        contenido += "          REPORTE DE ENTREGAS GO!       \n";
        contenido += "========================================\n";
        contenido += `Generado: ${new Date().toLocaleString()}\n`;
        contenido += `Precio Base: S/. ${precioPorPedido.toFixed(2)}\n\n`;
        
        let granTotalDinero = 0;
        let granTotalItems = 0;
        let hayDatos = false;

        fechasExportar.forEach(f => {
            if(!dbRutas[f]) return;
            const clean = dbRutas[f].filter(r => !r.esRepetido);
            if(clean.length === 0) return;
            
            hayDatos = true;
            const pedidos = clean.filter(r => r.tipo !== 'CASO');
            const casos = clean.filter(r => r.tipo === 'CASO');
            
            let totalDia = 0;
            
            contenido += `----------------------------------------\n`;
            contenido += ` FECHA: ${formatearFecha(f).toUpperCase()} (${clean.length} Items)\n`;
            contenido += `----------------------------------------\n`;

            if (pedidos.length > 0) {
                contenido += ` >> PEDIDOS (${pedidos.length}):\n`;
                pedidos.forEach((r, idx) => {
                    let p = r.precioEspecial ? parseFloat(r.precioEspecial) : precioPorPedido;
                    totalDia += p;
                    let nota = r.esManual ? " [MANUAL]" : "";
                    contenido += `    ${(idx+1).toString().padStart(2,'0')}. ${r.numero} - S/.${p.toFixed(2)}${nota}\n`;
                });
                contenido += "\n";
            }

            if (casos.length > 0) {
                contenido += ` >> CASOS (${casos.length}):\n`;
                casos.forEach((r, idx) => {
                    let p = r.precioEspecial ? parseFloat(r.precioEspecial) : precioPorPedido;
                    totalDia += p;
                    let nota = r.esManual ? " [MANUAL]" : "";
                    contenido += `    ${(idx+1).toString().padStart(2,'0')}. ${r.numero} - S/.${p.toFixed(2)}${nota}\n`;
                });
                contenido += "\n";
            }
            
            contenido += ` SUBTOTAL DIA: S/. ${totalDia.toFixed(2)}\n\n`;
            granTotalDinero += totalDia;
            granTotalItems += clean.length;
        });

        if(!hayDatos) return alert("‚ö†Ô∏è La selecci√≥n no contiene registros v√°lidos.");

        contenido += `========================================\n`;
        contenido += ` RESUMEN FINAL\n`;
        contenido += `========================================\n`;
        contenido += ` TOTAL REGISTROS: ${granTotalItems}\n`;
        contenido += ` MONTO TOTAL:     S/. ${granTotalDinero.toFixed(2)}\n`;
        contenido += `========================================`;

        const blob = new Blob(['\uFEFF' + contenido], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Reporte_Go_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
    }

    // --- FUNCIONES AUDITOR√çA EXCEL MEJORADA ---
    function leerExcelOptimizado(archivo) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes("planilla")) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    // Identificar columnas
                    let colGuia = -1, colBono = -1, colNombre = -1;
                    const limiteBusqueda = Math.min(jsonData.length, 50);
                    let filaEncabezado = -1;

                    for (let i = 0; i < limiteBusqueda; i++) {
                        const row = jsonData[i];
                        for (let j = 0; j < row.length; j++) {
                            const val = String(row[j]).toUpperCase();
                            if (val.includes("NRO") && val.includes("GUIA")) colGuia = j;
                            if (val.includes("BONO") && val.includes("PEDIDO")) colBono = j;
                            if (val.includes("NOMBRE") && val.includes("COMPLETO")) colNombre = j;
                        }
                        if (colGuia !== -1) {
                            filaEncabezado = i;
                            break;
                        }
                    }

                    if(colGuia === -1) {
                        reject(new Error("No se encontr√≥ la columna 'NRO DE GUIA'."));
                        return;
                    }

                    // Extraer todos los datos relevantes del Excel
                    const rawData = [];
                    const regex8 = /(\d{8})/;
                    
                    for (let k = filaEncabezado + 1; k < jsonData.length; k++) {
                        const fila = jsonData[k];
                        
                        let nombre = "DESCONOCIDO";
                        if(colNombre !== -1 && fila[colNombre]) {
                            nombre = String(fila[colNombre]).trim().toUpperCase();
                        }

                        // Si hay nombre, intentamos extraer datos
                        if (nombre !== "DESCONOCIDO") {
                            let match = null;
                            if (fila[colGuia]) {
                                match = String(fila[colGuia]).match(regex8);
                            }

                            let bono = 0;
                            if (colBono !== -1 && fila[colBono]) {
                                let raw = String(fila[colBono]).replace(/[^\d.]/g, '');
                                bono = parseFloat(raw) || 0;
                            }

                            // ACEPTAR SI HAY CODIGO O HAY BONO
                            if (match || bono > 0) {
                                rawData.push({ 
                                    codigo: match ? match[1] : `SIN-CODIGO-${k}`, // ID temporal si es solo bono
                                    nombre: nombre, 
                                    bono: bono 
                                });
                            }
                        }
                    }
                    resolve(rawData);

                } catch (err) { reject(err); }
            };
            reader.readAsArrayBuffer(archivo);
        });
    }

    async function procesarComparacionExcel(input) {
        if (!input.files.length) return;
        const divRes = document.getElementById('audit-results');
        divRes.innerHTML = "<div style='text-align:center; color:#64748B;'>‚è≥ Analizando...</div>";
        
        try {
            const excelData = await leerExcelOptimizado(input.files[0]);
            
            // 1. AUTO-DETECTAR NOMBRE DEL USUARIO
            // Comparamos tus c√≥digos escaneados con los del Excel para ver con qu√© nombre coinciden m√°s.
            const nameHits = {};
            let maxHits = 0;
            let detectedName = null;

            // Conjunto de mis c√≥digos para b√∫squeda r√°pida
            const misCodigos = new Set(datosComparacion.map(d => d.codigo));

            excelData.forEach(row => {
                if(misCodigos.has(row.codigo)) {
                    if(!nameHits[row.nombre]) nameHits[row.nombre] = 0;
                    nameHits[row.nombre]++;
                    if(nameHits[row.nombre] > maxHits) {
                        maxHits = nameHits[row.nombre];
                        detectedName = row.nombre;
                    }
                }
            });

            if(!detectedName) {
                throw new Error("No se encontraron coincidencias de tus pedidos en este Excel.");
            }

            // 2. FILTRAR EXCEL SOLO POR EL NOMBRE DETECTADO
            // Esto evita sumar bonos de otros conductores (el problema de los 1080 soles)
            const codigosPagadosUsuario = new Set();
            let sumaBonosUsuario = 0;

            excelData.forEach(row => {
                if(row.nombre === detectedName) {
                    codigosPagadosUsuario.add(row.codigo);
                    sumaBonosUsuario += row.bono;
                }
            });

            // 3. COMPARAR
            const listaFaltantes = []; // En App pero NO en Excel
            const listaManuales = [];
            const listaSobranEnExcel = []; // En Excel pero NO en App

            datosComparacion.forEach(item => {
                if (item.esManual) {
                    listaManuales.push(item);
                } else {
                    // Si no es manual, debe estar en el Excel bajo MI nombre
                    if (!codigosPagadosUsuario.has(item.codigo)) {
                        listaFaltantes.push(item);
                    }
                }
            });

            // Buscar inversa: Qu√© hay en Excel que yo NO tengo (y son de mi nombre)
            // Recorremos los datos originales filtrados por nombre para encontrar c√≥digos
            excelData.forEach(row => {
                if (row.nombre === detectedName && row.codigo && !row.codigo.startsWith('SIN-CODIGO')) {
                    if (!misCodigos.has(row.codigo)) {
                        listaSobranEnExcel.push(row.codigo);
                    }
                }
            });

            renderizarResultadosAuditoria(listaFaltantes, listaManuales, sumaBonosUsuario, detectedName, listaSobranEnExcel);
            playSound('success');

        } catch (error) {
            console.error(error);
            divRes.innerHTML = `<div style='color:red; text-align:center'>Error: ${error.message}</div>`;
            playSound('error');
        }
    }

    function renderizarResultadosAuditoria(faltantes, manuales, sumaBonos, nombreDetectado, sobranEnExcel) {
        let html = `<div style="text-align:center; font-size:11px; color:#64748b; margin-bottom:10px;">
                        Analizando para: <strong style="color:var(--primary)">${nombreDetectado}</strong>
                    </div>`;

        // FALTANTES (APP > EXCEL)
        if (faltantes.length === 0) {
            html += `<div style='background:#f0fdf4; color:#15803d; padding:15px; border-radius:12px; text-align:center; margin-bottom:15px;'>
                        <h3 style='margin:0;'>‚úÖ TODO PAGADO</h3>
                        <p style='margin:5px 0 0 0; font-size:12px;'>No faltan pedidos regulares en tu planilla.</p>
                     </div>`;
        } else {
            html += `<div style='background:#fef2f2; border:1px solid #fecaca; padding:15px; border-radius:12px; margin-bottom:15px;'>
                        <h3 style='color:#991b1b; margin:0 0 10px 0; font-size:14px;'>‚ö†Ô∏è NO TE HAN CONSIDERADO ${faltantes.length} C√ìDIGO(S)</h3>
                        <div style='max-height:200px; overflow-y:auto;'>`;
            faltantes.forEach(f => {
                html += `<div style='display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #fee2e2; font-size:13px;'>
                            <span style='background:var(--primary); color:white; padding:2px 6px; border-radius:4px; font-size:10px;'>${f.fecha || 'N/A'}</span>
                            <span style='font-family:monospace; font-weight:bold; color:#b91c1c;'>${f.codigo}</span>
                         </div>`;
            });
            html += `</div></div>`;
        }

        // NO ANOTADOS (EXCEL > APP)
        if (sobranEnExcel && sobranEnExcel.length > 0) {
             html += `<div style='background:#eff6ff; border:1px solid #dbeafe; padding:15px; border-radius:12px; margin-bottom:15px;'>
                        <h3 style='color:#1e40af; margin:0 0 10px 0; font-size:14px;'>‚ÑπÔ∏è ${sobranEnExcel.length} EN EXCEL (NO ANOTADOS)</h3>
                        <div style='max-height:200px; overflow-y:auto;'>`;
            sobranEnExcel.forEach(code => {
                html += `<div style='padding:8px 0; border-bottom:1px solid #dbeafe; font-size:13px; font-family:monospace; color:#1e3a8a;'>
                            ${code}
                         </div>`;
            });
            html += `</div></div>`;
        }

        // MANUALES VS BONOS
        const cantManuales = manuales.length;
        // Precio estimado manual (usamos el precio base configurado)
        const dineroNecesario = cantManuales * precioPorPedido; 
        
        // Calculo de diferencia
        const dineroFaltante = dineroNecesario - sumaBonos;
        // Convertir dinero faltante a cantidad de pedidos (redondeado hacia arriba)
        const faltanManualesCnt = dineroFaltante > 0 ? (dineroFaltante / precioPorPedido) : 0;
        
        const cubierto = dineroFaltante <= 0;
        const colorAlert = cubierto ? '#065F46' : '#92400E';
        const bgAlert = cubierto ? '#ECFDF5' : '#FFFBEB';
        const borderAlert = cubierto ? '#A7F3D0' : '#FDE68A';

        html += `<div style='background:${bgAlert}; border:1px solid ${borderAlert}; padding:15px; border-radius:12px;'>
                    <h3 style='margin:0 0 5px 0; font-size:14px; color:${colorAlert};'>Gesti√≥n de Manuales (${cantManuales})</h3>
                    <p style='font-size:12px; margin:0; color:${colorAlert};'>
                        ${cubierto ? '‚úÖ' : '‚ö†Ô∏è'} Bonos en Excel: <b>S/. ${sumaBonos.toFixed(2)}</b><br>
                        ${cubierto 
                            ? 'Cubren tus manuales.' 
                            : `No te est√°n considerando <b>${faltanManualesCnt}</b> pedido(s) o caso(s) manual(es).`}
                    </p>
                 </div>`;

        document.getElementById('audit-results').innerHTML = html;
    }
</script>

<script>
    // Registro del Service Worker para PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('ServiceWorker registrado con √©xito: ', registration.scope);
            }, function(err) {
                console.log('ServiceWorker fall√≥: ', err);
            });
        });
    }
</script>

<script type="text/javascript" src="/hosting__contador__visitas__unicas.php?h=2209378&amp;t=1768618341&amp;k=40adcbd68157c1bf8a39ddfe133ffc1c&amp;__muid="></script>
</body>
</html>